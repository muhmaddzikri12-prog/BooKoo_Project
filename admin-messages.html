<!DOCTYPE html>
<html lang="id">

<head>
    <title>Kotak Masuk - Admin PustakaKita</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Style Tambahan untuk Pesan */
        
        .msg-content {
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.9rem;
            color: #334155;
            max-height: 80px;
            overflow-y: auto;
        }
        
        .badge-subject {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .bg-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        /* Info */
        
        .bg-red {
            background: #fee2e2;
            color: #991b1b;
        }
        /* Komplain */
        
        .bg-green {
            background: #dcfce7;
            color: #166534;
        }
        /* Request */
    </style>
</head>

<body style="background-color: #f3f4f6;">

    <script>
        if (!localStorage.getItem('admin_token')) {
            window.location.href = 'admin-login.html';
        }
    </script>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="admin-container">

        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-book-open"></i> BooKoo
                <span style="font-size: 0.8rem; display:block; margin-top:5px; opacity:0.7;">Administrator</span>
            </div>
            <ul class="sidebar-menu">
                <li><a href="admin.html"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="admin-products.html"><i class="fas fa-book"></i> Kelola Produk</a></li>
                <li><a href="admin-orders.html"><i class="fas fa-shopping-cart"></i> Pesanan Masuk</a></li>
                <li><a href="admin-messages.html" class="active"><i class="fas fa-envelope"></i> Kotak Masuk</a></li>

                <li style="margin-top: auto;">
                    <a href="#" onclick="adminLogout()" style="color: #ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="admin-header">
                <div style="display: flex; align-items: center;">
                    <button class="admin-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2>Pesan & Masukan</h2>
                </div>

                <div style="font-size: 0.9rem; color: #666;">
                    Total: <b id="msg-count">0</b> Pesan
                </div>
            </header>

            <div class="recent-orders-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th width="150">Tanggal & Pengirim</th>
                            <th width="150">Kategori</th>
                            <th>Isi Pesan</th>
                            <th width="100">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="messages-table-body">
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="clearAllMessages()" class="btn btn-outline" style="border-color: #ef4444; color: #ef4444;">
                    <i class="fas fa-trash-alt"></i> Hapus Semua Pesan
                </button>
            </div>

        </main>
    </div>

    <script src="js/data.js"></script>
    <script>
        let messages = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadMessages();
        });

        function loadMessages() {
            // Ambil data dari LocalStorage
            messages = JSON.parse(localStorage.getItem('messages')) || [];
            document.getElementById('msg-count').innerText = messages.length;

            const tbody = document.getElementById('messages-table-body');

            if (messages.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 3rem; color:#888;">Belum ada pesan masuk.</td></tr>`;
                return;
            }

            let html = '';
            messages.forEach((msg) => {
                // Warna Badge Kategori
                let badgeClass = 'bg-blue';
                if (msg.subject.includes('Komplain')) badgeClass = 'bg-red';
                if (msg.subject.includes('Request')) badgeClass = 'bg-green';

                // Link WA Balasan
                // Format: Halo [Nama], menanggapi pesan Anda tentang [Topik]...
                const replyText = `Halo Kak ${msg.name}, menanggapi pesan Anda di Website PustakaKita mengenai "${msg.subject}"...`;
                const waLink = `https://wa.me/${formatWANumber(msg.phone)}?text=${encodeURIComponent(replyText)}`;

                html += `
                    <tr>
                        <td style="vertical-align: top;">
                            <small style="color:#888;">${msg.date}</small><br>
                            <strong>${msg.name}</strong><br>
                            <span style="font-size:0.85rem; color:#666;">${msg.email}</span>
                        </td>
                        <td style="vertical-align: top;">
                            <span class="badge-subject ${badgeClass}">${msg.subject}</span>
                        </td>
                        <td>
                            <div class="msg-content">
                                "${msg.message}"
                            </div>
                            <div style="margin-top:8px;">
                                <a href="${waLink}" target="_blank" style="font-size:0.8rem; color:#16a34a; font-weight:600; text-decoration:none;">
                                    <i class="fab fa-whatsapp"></i> Balas via WA
                                </a>
                            </div>
                        </td>
                        <td style="vertical-align: top; text-align:center;">
                            <button class="btn-action delete" onclick="deleteMessage(${msg.id})" title="Hapus Pesan">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Hapus 1 Pesan
        function deleteMessage(id) {
            if (confirm('Hapus pesan ini?')) {
                messages = messages.filter(m => m.id !== id);
                localStorage.setItem('messages', JSON.stringify(messages));
                loadMessages();
            }
        }

        // Hapus Semua
        function clearAllMessages() {
            if (confirm('PERINGATAN: Semua pesan akan dihapus permanen. Lanjutkan?')) {
                localStorage.removeItem('messages');
                loadMessages();
            }
        }

        // Helper: Format 08... jadi 628...
        function formatWANumber(phone) {
            if (!phone) return '';
            let p = phone.replace(/[^0-9]/g, ''); // Hapus spasi/strip
            if (p.startsWith('0')) {
                return '62' + p.slice(1);
            }
            return p;
        }

        // Fungsi Sidebar Mobile
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('show');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        }

        // Fungsi Logout
        function adminLogout() {
            if (confirm('Keluar dari Admin?')) {
                localStorage.removeItem('admin_token');
                window.location.href = 'admin-login.html';
            }
        }
    </script>
</body>

</html>