<!DOCTYPE html>
<html lang="id">

<head>
    <title>Kelola Produk - Admin PustakaKita</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body style="background-color: #f3f4f6;">

    <script>
        if (!localStorage.getItem('admin_token')) {
            alert('Akses Ditolak! Silakan login admin terlebih dahulu.');
            window.location.href = 'admin-login.html';
        }
    </script>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-book-open"></i> BooKoo
                <span style="font-size: 0.8rem; display:block; margin-top:5px; opacity:0.7;">Administrator</span>
            </div>
            <ul class="sidebar-menu">
                <li><a href="admin.html"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="admin-products.html" class="active"><i class="fas fa-book"></i> Kelola Produk</a></li>
                <li><a href="admin-orders.html"><i class="fas fa-shopping-cart"></i> Pesanan Masuk</a></li>
                <li>
                    <a href="admin-messages.html">
                        <i class="fas fa-envelope"></i> Kotak Masuk
                    </a>
                </li>
                <li style="margin-top: auto;">
                    <a href="#" onclick="adminLogout()" style="color: #ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="admin-header">
                <div style="display: flex; align-items: center;">
                    <button class="admin-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2>Daftar Buku</h2>
                </div>

                <button class="btn btn-primary" onclick="openModal('add')">
                    <i class="fas fa-plus"></i> Tambah Buku
                </button>
            </header>

            <div class="recent-orders-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th width="50">No</th>
                            <th width="80">Gambar</th>
                            <th>Judul Buku</th>
                            <th>Harga</th>
                            <th>Stok</th>
                            <th width="120">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body">
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Tambah Buku Baru</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label>Judul Buku</label>
                        <input type="text" id="pName" class="form-control" required placeholder="Contoh: Laskar Pelangi">
                    </div>

                    <div class="form-row">
                        <div class="form-group half">
                            <label>Harga (Rp)</label>
                            <input type="number" id="pPrice" class="form-control" required placeholder="100000">
                        </div>
                        <div class="form-group half">
                            <label>Stok</label>
                            <input type="number" id="pStock" class="form-control" required placeholder="10">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Link Gambar / Nama File</label>
                        <input type="text" id="pImage" class="form-control" required placeholder="img/buku1.jpg atau https://...">
                        <small style="color:#666; font-size:0.8rem;">Gunakan <code>img/namafile.jpg</code> jika file ada di folder img.</small>
                    </div>

                    <div class="form-group">
                        <label>Deskripsi Singkat</label>
                        <textarea id="pDesc" class="form-control" rows="3" required placeholder="Sinopsis buku..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Simpan Buku</button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script>
        // --- LOGIKA UTAMA ---
        let products = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });

        // 1. Muat Produk ke Tabel
        function loadProducts() {
            products = JSON.parse(localStorage.getItem('products')) || [];
            const tbody = document.getElementById('product-table-body');

            if (products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:2rem;">Belum ada buku. Silakan tambah data baru.</td></tr>`;
                return;
            }

            let html = '';
            products.forEach((p, index) => {
                // Logic Warna Stok
                let stockStyle = 'color:green; font-weight:bold;';
                if (p.stock < 10) stockStyle = 'color:#d97706; font-weight:bold;'; // Oranye
                if (p.stock === 0) stockStyle = 'color:red; font-weight:bold; background:#fee2e2; padding:2px 6px; border-radius:4px;';

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <img src="${p.image}" style="width:50px; height:70px; object-fit:cover; border-radius:4px; border:1px solid #eee;" onerror="this.src='https://via.placeholder.com/50x70?text=No+Img'">
                        </td>
                        <td>
                            <strong>${p.name}</strong><br>
                            <small style="color:#666;">ID: ${p.id}</small>
                        </td>
                        <td>${formatRupiah(p.price)}</td>
                        <td><span style="${stockStyle}">${p.stock}</span></td>
                        <td>
                            <button class="btn-action edit" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn-action delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // --- LOGIKA MODAL (POPUP) ---
        const modal = document.getElementById('productModal');

        function openModal(mode, id = null) {
            modal.style.display = 'flex'; // Tampilkan modal
            const form = document.getElementById('productForm');

            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = 'Tambah Buku Baru';
                document.getElementById('editId').value = '';
                form.reset();
            } else {
                document.getElementById('modalTitle').innerText = 'Edit Buku';
                const p = products.find(item => item.id === id);

                // Isi Form dengan data lama
                document.getElementById('editId').value = p.id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pPrice').value = p.price;
                document.getElementById('pStock').value = p.stock;
                document.getElementById('pImage').value = p.image;
                document.getElementById('pDesc').value = p.desc;
            }
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        // Klik Edit -> Buka Modal
        function editProduct(id) {
            openModal('edit', id);
        }

        // --- CRUD ACTIONS ---

        // 2. Simpan Data (Tambah / Update)
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const idEdit = document.getElementById('editId').value;
            const name = document.getElementById('pName').value;
            const price = parseInt(document.getElementById('pPrice').value);
            const stock = parseInt(document.getElementById('pStock').value);
            const image = document.getElementById('pImage').value;
            const desc = document.getElementById('pDesc').value;

            if (idEdit) {
                // UPDATE
                const index = products.findIndex(p => p.id == idEdit);
                if (index !== -1) {
                    products[index] = {
                        id: parseInt(idEdit),
                        name,
                        price,
                        desc,
                        image,
                        stock
                    };
                    alert('Data buku berhasil diperbarui!');
                }
            } else {
                // CREATE (Buat ID Baru)
                // Cari ID terbesar, tambah 1. Jika kosong mulai dari 1.
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({
                    id: newId,
                    name,
                    price,
                    desc,
                    image,
                    stock
                });
                alert('Buku baru berhasil ditambahkan!');
            }

            // Simpan ke LocalStorage & Refresh
            localStorage.setItem('products', JSON.stringify(products));
            closeModal();
            loadProducts();
        });

        // 3. Hapus Data
        function deleteProduct(id) {
            if (confirm('Apakah Anda yakin ingin menghapus buku ini dari daftar?')) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('products', JSON.stringify(products));
                loadProducts();
            }
        }

        // --- FUNGSI ADMIN UMUM (Responsive & Logout) ---

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function adminLogout() {
            if (confirm('Yakin ingin keluar dari Admin?')) {
                localStorage.removeItem('admin_token');
                window.location.href = 'admin-login.html';
            }
        }

        // Tutup modal jika klik di luar area putih
        window.onclick = function(event) {
            if (event.target == modal) closeModal();
        }

        // Helper Format Rupiah (Backup jika js/data.js error)
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }
    </script>
</body>

</html>